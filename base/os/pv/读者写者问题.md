---
tags:
  - os
---

é—®é¢˜æè¿°ï¼šå¯¹äºåŒä¸€ä¸ªæ–‡ä»¶ï¼Œè¯»æ“ä½œå¯ä»¥åŒæ—¶å¹¶è¡Œï¼Œè¯»å†™æ“ä½œäº’æ–¥ï¼Œå†™ä¸å†™äº’æ–¥ã€‚æœ¬è´¨ä¸Šå°±æ˜¯**åŒç±»è¿›ç¨‹ä¸äº’æ–¥**ï¼Œ**å¼‚ç±»è¿›ç¨‹äº’æ–¥**çš„é—®é¢˜ã€‚



### å…¨éƒ½äº’æ–¥

æœ€ç®€å•çš„è§£æ³•ï¼š

```pseudocode
semaphore lock = 1;

Reader(){ // è¯»è€…è¿›ç¨‹
    while(1){
        P(lock);
        è¯»æ–‡ä»¶;
        V(lock);
    }
}

Writer(){ // å†™è€…è¿›ç¨‹
    while(1){
        P(lock);
        å†™æ–‡ä»¶;
        V(lock);
    }
}
```

é—®é¢˜ï¼šè¯»è€…å’Œè¯»è€…ä¹‹é—´æ¯æ¬¡ä¹Ÿè¦pvï¼Œä¼šå¡åœ¨`p(lock)`æ—¶ï¼Œç°åœ¨éœ€è¦æƒ³åŠæ³•è·³è¿‡pvæ“ä½œã€‚



## è¯»ä¼˜å…ˆï¼ˆå†™ä¼˜å…ˆåŒç†ï¼‰

æ€è·¯ï¼šè®©ç¬¬ä¸€ä¸ªè¿›ç¨‹åŠ é”ğŸ”’ï¼Œæœ€åä¸€ä¸ªè¿›ç¨‹è§£é”ğŸ”“ã€‚è¿™æ ·ä¸­é—´çš„è¿›ç¨‹å°±å¯ä»¥ä¸pv, ç›´æ¥ä½¿ç”¨å•¦ã€‚

```c
semaphore lock = 1;
int count = 0; // è®°å½•æœ‰å¤šå°‘ä¸ªåœ¨ä½¿ç”¨

Reader(){ // è¯»è€…è¿›ç¨‹
    while(1){
        if(count == 0) // ç¬¬ä¸€ä¸ªæ¥çš„ä¸Šé”
            P(lock);
        count++;
        è¯»æ–‡ä»¶;
        count--;
        if(count == 0) // æœ€åä¸€ä¸ªèµ°çš„é‡Šæ”¾é”
            V(lock);
    }
}

Writer(){ // å†™è€…è¿›ç¨‹
    while(1){
        P(lock);
        å†™æ–‡ä»¶;
        V(lock);
    }
}
```

![diff1](https://pic-1257412153.cos.ap-nanjing.myqcloud.com/images/2023%2F12%2F20%2Fimage-20231220164159279-70cc69.png)



ç„¶è€Œï¼Œcountçš„è®¿é—®éœ€è¦äº’æ–¥ï¼Œå¦åˆ™æ•°æ®å°±ä¼šå†²çª

æ·»åŠ äº’æ–¥è®¿é—®ä»£ç ï¼š

```c
semaphore lock = 1;
mutex count_lock = 1; // äº’æ–¥è®¿é—®å˜é‡ count
int count = 0; // è®°å½•æœ‰å¤šå°‘ä¸ªåœ¨ä½¿ç”¨

Reader(){ // è¯»è€…è¿›ç¨‹
    while(1){
        p(count_lock);
        if(count == 0) // ç¬¬ä¸€ä¸ªæ¥çš„ä¸Šé”
            P(lock);
        count++;
        V(count_lock);
        è¯»æ–‡ä»¶;
        p(count_lock);
        count--;
        if(count == 0) // æœ€åä¸€ä¸ªèµ°çš„é‡Šæ”¾é”
            V(lock);
        V(count_lock);
    }
}

Writer(){ // å†™è€…è¿›ç¨‹
    while(1){
        P(lock);
        å†™æ–‡ä»¶;
        V(lock);
    }
}
```

![diff2](https://pic-1257412153.cos.ap-nanjing.myqcloud.com/images/2023%2F12%2F20%2Fimage-20231220163951358-89b9d9.png)



## ä¸å…è®¸è¯»è€…æˆ–å†™è€…é¥¿æ­»
å…¶å®å°±æ˜¯è¿è¡Œå†™è¿›ç¨‹æ’é˜Ÿæ‰§è¡Œã€‚
```c
semaphore rw = 1; // è¯»å†™é”
semaphore w = 1; // å†™é”
mutex count_lock = 1; // äº’æ–¥è®¿é—®å˜é‡ count
int count = 0; // è®°å½•æœ‰å¤šå°‘ä¸ªåœ¨ä½¿ç”¨

Reader(){ // è¯»è€…è¿›ç¨‹
    while(1){
        P(w);

        p(count_lock);
        if(count == 0) // ç¬¬ä¸€ä¸ªæ¥çš„ä¸Šé”
            P(rw);
        count++;
        V(count_lock);

        V(w);

        è¯»æ–‡ä»¶;
        p(count_lock);
        count--;
        if(count == 0) // æœ€åä¸€ä¸ªèµ°çš„é‡Šæ”¾é”
            V(rw);
        V(count_lock);
    }
}

Writer(){ // å†™è€…è¿›ç¨‹
    while(1){
        P(w);
        P(rw);
        å†™æ–‡ä»¶;
        V(rw);
        V(w);
    }
}
```

![image-20231220165139926](https://pic-1257412153.cos.ap-nanjing.myqcloud.com/images/2023%2F12%2F20%2Fimage-20231220165139926-0c410f.png)



è¿™æ ·ï¼Œå½“æœ‰è¯»è¿›ç¨‹åœ¨æ‰§è¡Œæ˜¯æ¥äº†ä¸ªå†™è¿›ç¨‹ï¼Œå†™è¿›ç¨‹åœ¨`P(w)`æˆåŠŸåä¼šå¡åœ¨`P(rw)`ä¸Šï¼Œè¿™æ—¶**åæ¥çš„**è¯»è¿›ç¨‹ä¼šå¡åœ¨`P(w)`ï¼Œç›´åˆ°ç°æœ‰çš„æ‰€æœ‰è¯»è¿›ç¨‹æ‰§è¡Œå®Œå¹¶é‡Šæ”¾é”ã€‚é‡Šæ”¾åå†™è¿›ç¨‹å°±å¯ä»¥**æ’é˜Ÿ**æˆåŠŸå•¦ã€‚