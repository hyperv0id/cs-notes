## 定义

**进程 (Process)** 是被加载到内存中、正在运行的程序。多个进程可能对应同一个程序。一个正在运行的 OS 中会有多个进程。进程是程序的一次执行过程，是操作系统分配资源的基本单位。

### 组成

- PCB
- 程序段
  - 程序的代码、指令序列
- 数据段
  - 变量

### 状态

![进程状态转移图](https://pic-1257412153.cos.ap-nanjing.myqcloud.com/images/2023/06/16/2022-12-08-16-38-05-57bbda.png)



1. 创建---就绪---运行---挂掉
2. 创建---就绪---运行---阻塞(请求打印机等)---再运行



### PCB

每个进程创建时都会创建一个PCB, 用于保存进程信息

PCB 包含许多当前进程的相关信息：

- 



## 进程控制

### 基本概念

进程控制：就是实现进程状态转换

> 原语：具有原子性的操作。
>
> 基于**开中断**和**关中断**特权指令实现
>
> ![image-20230616195013404](https://pic-1257412153.cos.ap-nanjing.myqcloud.com/images/2023/06/16/image-20230616195013404-5ade98.png)



### 进程控制相关原语

#### 创建

1. 创建新PCB
2. 分配资源
3. 初始化
4. 插入就绪队列



#### 终止

1. 找到对应PCB
2. 如果正在运行，剥夺CPU
3. 终止所有子进程
4. 归还资源
5. 删除PCB

#### 阻塞

1. 找到PCB
2. 保护运行现场，状态设为阻塞态，让进程滚蛋
3. 放到阻塞队列



#### 唤醒

1. 找PCB
2. pop等待队列
3. PCB = 就绪
4. 放入就绪队列



#### 切换

1. 保存现场
2. PCB移入相应队列
3. 更新PCB
4. 根据PCB恢复环境



## 进程通信IPC

两个或者多个进程之间的数据传送

- **信号量 (semaphores)** 本意用来线程间同步，但是可以通过 sem_open() 系统调用来建立和维护进程间的信号量；这样的信号量属于 OS 资源，它会在相关进程结束后由 OS 释放[3](https://xuan-insr.github.io/核心知识/os/II_process_management/3_process/#fn:3)[4](https://xuan-insr.github.io/核心知识/os/II_process_management/3_process/#fn:4)。

- **共享内存** 的实现是，两个进程各自有一块虚拟内存，映射到同一块物理内存。共享内存也需要信号量等同步手段保护。

- **共享文件**。

- **管道 (pipe)**。管道的实现其实也是文件，创建管道时操作系统会返回两端的文件描述符；逻辑上实现的是一个单工的信道。要实现双向数据传输需要两个管道。

- 消息队列 (message queue)

  。为什么需要消息队列呢？共享文件显然很慢，而共享内存比较难适用信息大小不等、信息读一次就失效等场景，且共享内存需要同步手段。消息队列可以解决这些问题。

  - 消息队列，其实就是操作系统维护的一个一个的链表，进程可以新建或者连接到一个消息队列，并写入消息，或读取第一条满足一定条件的消息。

- **Socket**。TCP / UDP，适用于双方不一定在同一个计算机上的情况。

### 共享存储

创建共享存储内存区，一个写一个读，访问互斥。

```cpp
// Linux
int shm_open(...); // 申请共享存储空间
void* mmap(...); // 共享内存区映射到自己的存储空间
```



### 消息传递

@golang

通过消息传递实现并发，由OS的发送消息/接受消息两个原语实现。

#### 直接通信

直接发送接收方ID。

```cpp
// 进程P
send(Q, msg);
// 进程Q
receive(P, &msg);
```



#### 间接通信

通过信箱间接通信

```cpp
// 进程P
send(A, msg);
// 进程Q
receive(A, &msg);
```

![image-20230616201650825](https://pic-1257412153.cos.ap-nanjing.myqcloud.com/images/2023/06/16/image-20230616201650825-67a69c.png)

### 管道

![image-20230616201824757](https://pic-1257412153.cos.ap-nanjing.myqcloud.com/images/2023/06/16/image-20230616201824757-e26419.png)

实际是一个半双工信道。本质上是一个循环队列。

![管道实现全双工通信](https://pic-1257412153.cos.ap-nanjing.myqcloud.com/images/2023/06/16/image-20230616202105252-08056b.png)


- 管道允许多写单读（2014-408
- 管道允许多写多读（Linux，读者轮流读）