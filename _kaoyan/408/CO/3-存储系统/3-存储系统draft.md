# 3-存储系统

## 3.1-层次结构

### 层次结构

层次金字塔：

![image-20230607212902603](https://pic-1257412153.cos.ap-nanjing.myqcloud.com/images/2023/06/07/image-20230607212902603-dedc3b-e2390c.png)

CPU直接读写：cache、主存

Cache-主存：解决了CPU和主存速度不匹配的问题

主存-辅存：OS实现**虚拟存储系统**，解决容量不够的问题。OS实现**页面置换算法**，决定要将哪些数据放到内存。

> 部分教材将磁盘、光盘等统称为外存

### 性能指标

- 单位成本：每位价格=总成本/总容量

- 存储容量：存储字数×字长

- 存储速度：数据传输率=数据的宽度(存储字长)/存储周期

- ==主存带宽==$B_m$：也叫**数据传输率**，表示每秒从主存进出的最大数量

- ==存储周期==： 存取时间+恢复时间

  ![image-20230607221441880](https://pic-1257412153.cos.ap-nanjing.myqcloud.com/images/2023/06/07/image-20230607221441880-8ce578.png)

  - 存取时间$T_a$：存储器完成一次操作的时间，分为存取和恢复
  - 存取周期$T_m$：一次完整的读/写周期。主存的DRAM芯片是破坏性读

### 分类

#### 根据介质分类

1. 半导体：主存、cache
2. 磁性材料：磁带、磁盘
3. 光存储器：光盘

#### 存取方式

1. RAM：读写速度和位置无关
2. SAM：读写和位置有关（磁带）
3. DAM：直接存取存储（多层磁带）
4. CAM：相联存储器。根据内容检索到位置

#### 信息可更改性

1. 只读：只能读，不能写
   1. 光盘
   2. bios：一个rom芯片，很难写
2. 读写
   1. 磁盘、内存、cache

#### 信息可保存性

1. 易失
   1. 断电丢失
   2. 主存、cache
2. 非易失
   1. 断电不丢失
   2. 磁盘、光盘

3. 破坏读
   1. 信息读出后存储信息被破坏，读出后需要重新写
   2. DRAM芯片
4. 非破环读
   1. 信息读出后存储信息还在
   2. SRAM芯片



## 3.2-主存储器

### 主存的基本组成

#### 存储芯片

> 关于数据如何存储，如何读取，以及如何控制

存储体 > 存储单元 > 存储元

一个存储元存一个bit，存储单元存一个存储字。

![image-20230607223031711](https://pic-1257412153.cos.ap-nanjing.myqcloud.com/images/2023/06/07/image-20230607223031711-7ed735.png) 



译码器：根据MAR**地址**转变成选通线的**高电平**

![image-20230607223413919](https://pic-1257412153.cos.ap-nanjing.myqcloud.com/images/2023/06/07/image-20230607223413919-8ac7f2.png)

**控制电路**<img src="https://pic-1257412153.cos.ap-nanjing.myqcloud.com/images/2023/06/07/image-20230607223648420-e541d8.png" alt="image-20230607223648420" align="right" style="zoom:50%;" />

1. 稳定信号：只有MAR稳定后才送给译码器，只有MDR稳定后才读取。
2. $\overline{CS}$ 或 $\overline{CE}$：选中哪个芯片。
3. $\overline{WE} + \overline{OE}$：单独控制允许读/写。
4. $\overline{WE}$：一条线控制读写 





![](https://pic-1257412153.cos.ap-nanjing.myqcloud.com/images/2023/06/07/image-20230607224319173-aab8e1.png)

驱动器：稳定和放大译码器的字选信号

存储芯片的引脚个数：$$片选线 + 读写控制线(1到2个) + (地址线+数据线) = 1+2 \times 地址位数 + \overline{WE} + \overline{OE}$$ 

#### 寻址方式

多个字节排成一行构成一个**字**

![image-20230607225256812](https://pic-1257412153.cos.ap-nanjing.myqcloud.com/images/2023/06/07/image-20230607225256812-ed89d4.png)

### ==SRAM & DRAM==

#### 底层电路

![栅极电容 vs 双稳态触发器](https://pic-1257412153.cos.ap-nanjing.myqcloud.com/images/2023/06/07/image-20230607225525877-a5f090.png)

栅极电容会不断流失电荷，所以每次读取都会丢失数据o(TヘTo)。

双稳态触发器不会流失电荷，但是不容易集成。



| 类型特点           | SRAM        | DRAM                     |
| :----------------- | :---------- | :----------------------- |
| 存储信息           | 触发器      | 电容                     |
| 破坏性读出         | 非          | 是                       |
| 读出后是否需要重写 | 不用        | 需要                     |
| 运行速度           | 快          | 慢                       |
| 集成度             | 低          | 高                       |
| 发热量             | 大          | 小                       |
| 存储成本           | 高          | 低                       |
| 是否易失           | 易失        | 易失                     |
| 是否需要刷新       | 不需要      | 需要（分散、集中、异步） |
| 作用               | 常用作Cache | 常用作主存               |
| 送行列地址         | 同时送      | 分两次（地址复用技术）   |

SDRAM：现在主流的DDR3、DDR4芯片

#### ==DRAM地址复用==

![DRAM地址复用技术](https://pic-1257412153.cos.ap-nanjing.myqcloud.com/images/2023/06/07/image-20230607231343389-d97ed3.png)



#### ==DRAM刷新==

- 多久需要刷新一次？

  电容最多2ms，所以一般为2ms

- 每次刷新多少存储单元？

  按行列存储，每次刷新一行

- 如何刷新？

  硬件支持，读取一行信息后重新写入，占一个存储周期。

- 什么时刻刷新？

  ![DRAM刷新方式](https://pic-1257412153.cos.ap-nanjing.myqcloud.com/images/2023/06/07/image-20230607230918829-cbbe0a.png)

  1. 分散刷新：每次读写后都刷新
  2. 集中刷新：2ms中集中一段时间全部刷新，存在死区。
  3. 异步刷新：每隔一段时间刷新一行



### ROM

- MROM：掩模式只读。写入后**任何人**不能重写
- PROM：可编程。专门的PROM写入器写入，**写入一次**后不可更改。
- EPROM：可擦除、可编程。可多次重写
  - UVEPROM：紫外线，只能擦除**全部**字
  - EEPROM：电擦除，支持查出特定字。
- Flash Memory：
  - 快速擦除，写前需要先擦除，写比读慢。
  - 使用单个MOS管，存储信息多。
- SSD：Solid State Drives固态硬盘
  - 控制单元+Flash构成，支持快速擦除



Hint：

BIOS：存储**自举装入程序**，用来引导开机。

CPU将主板的ROM也当作主存看待，将二者统一编制。

ROM现在可以看作支持随机存取啦



## 3.3-主存和CPU连接

### 位扩展

存储器的**数据线**太短，需要多连几个。

![image-20230607233529186](https://pic-1257412153.cos.ap-nanjing.myqcloud.com/images/2023/06/07/image-20230607233529186-297e42.png)



### 字扩展

问题：存储器的**地址线**太短

线选法：<img src="https://pic-1257412153.cos.ap-nanjing.myqcloud.com/images/2023/06/07/image-20230607234043481-e2a818.png" alt="image-20230607234043481" style="zoom:50%;"/>

采用**译码器**的片选法：<img src="https://pic-1257412153.cos.ap-nanjing.myqcloud.com/images/2023/06/07/image-20230607234231903-d71819.png" alt="image-20230607234231903" style="zoom:50%;" />



### 字位扩展

![image-20230607234739113](https://pic-1257412153.cos.ap-nanjing.myqcloud.com/images/2023/06/07/image-20230607234739113-20606e.png)

两个芯片为一组，用来位扩展，这是两个一组的芯片看作一个芯片。

然后每组采用字扩展。



## 3.4-提升主存速度

### 双口RAM

优化多核CPU访问一根内存条



双端口RAM技术：双倍的地址线和数据线，让多个CPU同时读同一块内存条

![image-20230607235351875](https://pic-1257412153.cos.ap-nanjing.myqcloud.com/images/2023/06/07/image-20230607235351875-377fb5.png)

> 新问题：
>
> 同时读/写会冲突：写入错误，读入错误。
>
> 解决方案：一个“忙”信号，0代表忙，操作会被延迟。（OS读者/写着问题）



### 多体并行存储器



![image-20230607235719849](https://pic-1257412153.cos.ap-nanjing.myqcloud.com/images/2023/06/07/image-20230607235719849-d48c76.png)



高位：**XX**00000000。（XX代表内存条寻址）

地位：00000000**XX**。



高位交叉编址：每次读取都需要等待存储体恢复，读连续的地址会卡住。

==地位交叉编址==：每次读完去读另一个存储体，更高效。

![image-20230608000417941](https://pic-1257412153.cos.ap-nanjing.myqcloud.com/images/2023/06/08/image-20230608000417941-0f355b.png)



### 单体多字存储器

![image-20230608001132304](https://pic-1257412153.cos.ap-nanjing.myqcloud.com/images/2023/06/08/image-20230608001132304-474f33.png)

## 3.5-外存

### 3.5.1-磁盘

see：https://jyywiki.cn/OS/2022/slides/23.slides

采用磁性材质，切割磁感线，改变磁图层的方向。

<img src="https://jyywiki.cn/pages/OS/img/mag-draw-board.jpg" alt="img" style="zoom:50%;" />





| 驱动器号           | 柱面号             | 盘面号   | 扇区号             |
| ------------------ | ------------------ | -------- | ------------------ |
| 一个电脑由多个硬盘 | 移动磁头臂（寻道） | 激活磁头 | 旋转到特定磁头下方 |

















### 3.5.2-SSD