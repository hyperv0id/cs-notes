## 定义

就是压榨控制器的剩余价值，不能让它闲着

![小学奥数](https://pic-1257412153.cos.ap-nanjing.myqcloud.com/images/2023/06/18/20230618184714-2f3993.png)

### 顺序执行



![image-20230618170249425](https://pic-1257412153.cos.ap-nanjing.myqcloud.com/images/2023/06/18/image-20230618170249425-d191a0.png)

硬件设计比较简单，但是部件的利用率低。
$$
T = 3\times t = 3t
$$

### 并行处理

#### 一次重叠

![image-20230618170342238](https://pic-1257412153.cos.ap-nanjing.myqcloud.com/images/2023/06/18/image-20230618170342238-c765ed.png)
$$
T = 3t + (n-1)\times 2t  = (1+2n)t
$$

#### 两次重叠

![image-20230618170454425](https://pic-1257412153.cos.ap-nanjing.myqcloud.com/images/2023/06/18/image-20230618170454425-275f86.png)
$$
T = 3T + (n-2)t = (1+n)t
$$
理想状态下效率更高

## 性能指标

### 吞吐率

> **吞吐率**：处理$n$个任务完成用时$T_k$，那么吞吐率$TP$为：$$TP = \frac{n}{T_k}$$
>
> 如果讲指令划分成$k$个阶段，每个阶段的耗时$\Delta t$，那么吞吐率为：$$TP = \frac{n}{(k+n-1)\Delta t}$$
> ![吞吐率 装入时间 排空时间](https://pic-1257412153.cos.ap-nanjing.myqcloud.com/images/2023/06/18/image-20230618171042790-a5bb49.png)
>
> **装入时间**：使得硬件部件投入使用的时间
>
> **排空时间**：释放部件的时间

### 加速比

> **加速比**：不使用流水线用时$T_0$与使用流水线后的时间$T_k$，加速比为：$$S = \frac{T_0}{T_k}$$
> $$
> \lim_{s\rightarrow +\infty}S = \frac{kn\Delta t}{(k+n-1)\Delta t} = k
> $$

### 效率

> **效率**：硬件设备的利用率
>
> ![流水线效率](https://pic-1257412153.cos.ap-nanjing.myqcloud.com/images/2023/06/18/image-20230618171631438-42a28e.png)
> $$
> 效率 = \frac{红色}{蓝色} = \frac{T_0}{k T_k}
> $$

## 机器周期设置

一个指令通常被划分为 5 个阶段：

1. **IF, Inst Fetch**，从内存中获取指令
2. **ID, Inst Decode**，读取寄存器、指令译码
3. **EX, Execute**，计算操作结果和/或地址
4. **MEM, Memory**，内存存取（如果需要的话）
5. **WB, Write Back**，将结果写回寄存器（如果需要的话）

![MIPS五段指令流水线](https://pic-1257412153.cos.ap-nanjing.myqcloud.com/images/2023/06/18/image-20230618172032538-f812b1.png)

## 影响因素

![image-20230618190130897](https://pic-1257412153.cos.ap-nanjing.myqcloud.com/images/2023/06/18/image-20230618190130897-3af9b0.png)

### 结构相关

多条指令争用**同一资源**

![image-20230618200441465](https://pic-1257412153.cos.ap-nanjing.myqcloud.com/images/2023/06/18/image-20230618200441465-b72268.png)

解决办法：

1. 后相关指令暂停一周期

2. 资源重复配置：

   1. 数据存储器、指令存储器

      ![image-20230618200728173](https://pic-1257412153.cos.ap-nanjing.myqcloud.com/images/2023/06/18/image-20230618200728173-3daae5.png)



### 数据相关

数据必须要前面的指令执行完才能执行当前的指令。

![数据相关](https://pic-1257412153.cos.ap-nanjing.myqcloud.com/images/2023/06/18/1654795975014-57ed0190-026f-4d9d-84eb-8a3f6fa3d26d-f9021f.png)

#### 等待

在等待的时间，什么都不干：硬件插入气泡，软件上插入nop

#### 数据旁路

```
add r1, r2, r3 # 将结果存入 r1
# 将ALU计算结果 `r1` 作为 ALU 的输出
add r4, r1, r5 # 使用 r1
```

#### 编译优化

编译器更改计算次序，在等待的时候执行不相关的指令（小学奥数。

### 控制相关

出现条件跳转，执行流中断

#### 分支预测

猜测PC会变成什么

#### 平行世界

做两手准备，计算出PC后，量子坍缩到现实世界。

#### 提前形成条件码

想办法先计算出PC, 取得那时候的指令

## 五段指令流水线

#TODO



## 多处理器

#TODO
